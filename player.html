<!DOCTYPE HTML>
<html>

	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<title>音乐播放</title>
		<link rel="stylesheet" href="css/mui.min.css" />
		<script src="js/mui.min.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript" src="js/common.js"></script>
		<link rel="stylesheet" type="text/css" href="fonts/iconfont.css" />
		<script type="text/javascript">
			var gentry = null,
				hl = null,
				le = null;
			var er = null,
				ep = null;
			// H5 plus事件处理
			function plusReady() {
				// 获取音频目录对象
				plus.io.resolveLocalFileSystemURL("_doc/", function(entry) {
					entry.getDirectory("audio", {
						create: true
					}, function(dir) {
						gentry = dir;
					}, function(e) {
						outSet("Get directory \"audio\" failed: " + e.message);
					});
				}, function(e) {
					outSet("Resolve \"_doc/\" failed: " + e.message);
				});
			}
			if (window.plus) {
				plusReady();
			} else {
				document.addEventListener("plusready", plusReady, false);
			}
			// DOMContentLoaded事件处理
			document.addEventListener("DOMContentLoaded", function() {
				// 获取DOM元素对象
				hl = document.getElementById("history");
				le = document.getElementById("empty");
				er = document.getElementById("record");
				rt = document.getElementById("rtime");
				ep = document.getElementById("play");
				pt = document.getElementById("ptime");
				st = document.getElementById("stime");
				pp = document.getElementById("progress")
			}, false);
			// 添加播放项
			function createItem(entry) {
				var li = document.createElement("li");
				li.className = "ditem";
				li.innerHTML = '<span class="iplay"><font class="aname"></font><br/><font class="ainf"></font></span>';
				li.setAttribute("onclick", "playAudio(this);");
				hl.insertBefore(li, le.nextSibling);
				li.querySelector(".aname").innerText = entry.name;
				li.querySelector(".ainf").innerText = "...";
				li.entry = entry;
				updateInformation(li);
				// 设置空项不可见
				le.style.display = "none";
			}
			// 播放音频文件
			function playAudio(li) {
				if (!li || !li.entry) {
					ouSet("无效的音频文件");
					return;
				}
				outSet("播放音频文件：" + li.entry.name);
				startPlay("_doc/audio/" + li.entry.name);
			}
			// 播放文件相关对象
			var p = null,
				pt = null,
				st = null,
				pp = null,
				pi = null;

			function load(url) {
				var xhr = new XMLHttpRequest();
				var ac = new(window.AudioContext || window.webkitAudioContext)();
				xhr.open("GET", url);
				xhr.responseType = "arraybuffer";
				xhr.onload = function() {
					ac.decodeAudioData(xhr.response, function(buffer) {
						var bufferSource = ac.createBufferSource();
						bufferSource.buffer = buffer;
						bufferSource.connect(ac.destination);
						bufferSource[bufferSource.start ? "start" : "noteOn"](0);
					}, function(err) {
						console.log(err);
					})
				}
				xhr.send();
			}
			// 开始播放
			function startPlay(url) {
				var pl = "undefined" == typeof(plus) ? null : plus;
				if (pl) {
					//ep.style.display = "block";
					//var L = pp.clientWidth;
					var L = 100;
					p = plus.audio.createPlayer(url);
					p.play(function() {
						//outLine("播放完成！");
						// 播放完成
						st.innerText = timeToStr(d);
						pt.innerText = timeToStr(d);
						pp.value = L;
						stopPlay();
					}, function(e) {
						//outLine("播放音频文件\"" + url + "\"失败：" + e.message);
					});
					// 获取总时长
					var d = p.getDuration();
					if (!d) {
						st.innerText = "00:00";
						pt.innerText = timeToStr(d);
					}
					pi = setInterval(function() {
						if (!d) { // 兼容无法及时获取总时长的情况
							d = p.getDuration();
						}
						var c = p.getPosition();
						if (!c) { // 兼容无法及时获取当前播放位置的情况
							return;
						}
						st.innerText = timeToStr(c);
						pt.innerText = timeToStr(d);
						var pct = Math.round(L * c / d);
						pp.value = pct;
					}, 1000);
				} else {
					url = url.substring(url.indexOf('/') + 1, url.length);
					load(url);
				}
			}
			// 停止播放
			function stopPlay() {
				clearInterval(pi);
				pi = null;
				setTimeout(resetPlay, 500);
				// 操作播放对象
				if (p) {
					p.stop();
					p = null;
				}
			}
			// 重置播放页面内容
			function resetPlay() {
				ep.style.display = "none";
				st.innerText = "00:00";
				pt.innerText = "00:00";
			}
			// 重写关闭
			var _back = window.back;

			function resetback() {
				// 停止播放
				if (ep.style.display == "block") {
					stopPlay();
				} else if (er.style.display == "block") {
					stopRecord();
				} else {
					_back();
				}
			}
			window.back = resetback;
		</script>
		<style type="text/css">
			html,
			body,
			.mui-content {
				height: 100%;
				background: rgba(0, 0, 0, 0.3);
			}
			
			.wrap {
				margin: 80px 0 0;
			}
			
			.record {
				width: 200px;
				height: 200px;
				margin: 0 auto;
				position: relative;
			}
			
			.record img {
				width: 200px;
				height: 200px;
				margin: 0 auto;
				border-radius: 200px;
			}
			
			@-webkit-keyframes rotateNow {
				0% {
					-webkit-transform: rotate(0);
				}
				100% {
					-webkit-transform: rotate(360deg);
				}
			}
			
			@-moz-keyframes rotateNow {
				0% {
					-moz-transform: rotate(0);
				}
				100% {
					-moz-transform: rotate(360deg);
				}
			}
			
			@keyframes rotateNow {
				0% {
					transform: rotate(0);
				}
				100% {
					transform: rotate(360deg);
				}
			}
			
			.rotateImg {
				-webkit-animation: rotateNow 10s linear 2s infinite;
				-moz-animation: rotateNow 10s linear 2s infinite;
				-o-animation: rotateNow 10s linear 2s infinite;
				animation: rotateNow 10s linear 2s infinite;
			}
			
			@-webkit-keyframes playNow {
				0% {
					-webkit-transform-origin: 66px top;
					-webkit-transform: rotate(0);
				}
				100% {
					-webkit-transform-origin: 66px top;
					-webkit-transform: rotate(30deg);
				}
			}
			
			@-moz-keyframes playNow {
				0% {
					-moz-transform-origin: 66px top;
					-moz-transform: rotate(0);
				}
				100% {
					-moz-transform-origin: 66px top;
					-moz-transform: rotate(30deg);
				}
			}
			
			@keyframes playNow {
				0% {
					transform-origin: 66px top;
					transform: rotate(0);
				}
				100% {
					transform-origin: 66px top;
					transform: rotate(30deg);
				}
			}
			
			.play {
				position: absolute;
				z-index: 100;
				right: -80px;
				top: -10px;
				background-image: url(images/play.png);
				background-position: 0 0;
				background-repeat: no-repeat;
				width: 143px;
				height: 134px;
			}
			
			.playNow {
				-webkit-animation: playNow 2s linear 2s;
				-moz-animation: playNow 2s linear 2s;
				-o-animation: playNow 2s linear 2s;
				animation: playNow 2s linear 2s;
			}
			
			.player-control {
				height: 150px;
				border: 1px solid #333333;
				position: absolute;
				bottom: 0px;
				left: 0px;
				width: 100%;
			}
			
			.control {
				width: 100%;
				height: 50px;
				line-height: 50px;
			}
			
			.progra {
				height: 80px;
				width: 100%;
			}
			
			.progra .mui-input-row.mui-input-range {
				padding: 30px 60px;
			}
			
			.progra .program {
				width: 100%;
				margin: 0 auto;
			}
			
			.control span {
				width: 20%;
				text-align: center;
				float: left;
			}
			
			.control .iconfont {
				color: #FFFFFF;
				font-size: 30px;
			}
			
			.control .icon-bofang {
				font-size: 40px;
				vertical-align: middle;
				padding-bottom: 8px;
				display: inline-block;
			}
			
			.ptime,
			.stime {
				position: absolute;
				font-size: 12px;
				top: 38px;
				color: #CCC;
			}
			
			.ptime {
				right: 20px;
			}
			
			.stime {
				left: 20px;
			}
			
			#progress {
				-webkit-transition: all 1s linear;
				transition: all 1s linear;
			}
			
			.mui-input-range input[type=range]::-webkit-slider-thumb {
				width: 15px;
				height: 15px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">音乐播放</h1>
		</header>
		<div class="mui-content">
			<div class="wrap">
				<div class="record">
					<img class="rotateImg" src="images/2.jpg" />
				</div>
			</div>
			<div class="player-control">
				<div class="progra">
					<div class="mui-input-row mui-input-range">
						<input type="range" id="progress" value="0" min="0" max="100" data-input-slider="4"><span class="mui-tooltip mui-hidden" style="left: 176.04px;">77</span>
					</div>
					<div id="ptime" class="ptime">00:00</div>
					<div id="stime" class="stime">00:00</div>
				</div>
				<div class="control">
					<span><i class="iconfont icon-suijibofang"></i></span>
					<span><i class="iconfont icon-shangyiqu"></i></span>
					<span onclick="startPlay('_www/audio/sering.mp3')"><i class="iconfont icon-bofang"></i></span>
					<span><i class="iconfont icon-xiayiqu"></i></span>
					<span><i class="iconfont icon-liebiao"></i></span>
				</div>
			</div>
		</div>
	</body>
	<script type="text/javascript" src="js/immersed.js"></script>

</html>